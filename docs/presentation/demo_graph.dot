digraph DemoFlow {
  rankdir=TB;
  splines=true;
  nodesep=0.4;
  ranksep=0.6;
  center=true;

  // Default node styles
  node [fontname="Helvetica", fontsize=11, style="rounded,filled", color="#666666", fontcolor="#222222", fillcolor="white", penwidth=1.0];

  // Define simple styling by type
  subgraph cluster_legend {
    label="Legend"; fontsize=10; color=gray90; style=dashed; labelloc="t"; labeljust="l";
    Lraw   [label="Raw (prov:Entity)", shape=box, fillcolor="#EEEEEE"];
    Lobs   [label="Observation (entity)", shape=box, fillcolor="#DDEEFF"];
    Lfeat  [label="Derived feature (entity)", shape=box, fillcolor="#E2F0D9"];
    Lact   [label="Computation (activity)", shape=ellipse, fillcolor="#FFF2CC"];
    Lparam [label="Parameter (prov:Entity)", shape=box, fillcolor="#FFE5D9"];
    Lwin   [label="Event window", shape=box, fillcolor="#FDE2E4"];
    Lpheno [label="Phenotype", shape=box, fillcolor="#EDE7F6"];
  }

  // Horizontal alignment anchor (fully invisible)
  CenterAnchor [shape=plaintext, label="", width=0, height=0, margin=0, fixedsize=true, style=invis, color=none, penwidth=0];

  // Raw entities (prov:Entity)
  subgraph cluster_raw {
    label="Raw (prov:Entity)"; style=dashed; color=gray60; labelloc="t"; labeljust="l";
    C_RAW [shape=plaintext, label="", width=0, height=0, margin=0, fixedsize=true, style=invis, color=none, penwidth=0];
    RawSteps [label="odim:RawStepsCSV\n(prov:Entity)", shape=box, fillcolor="#EEEEEE"];
    RawSleep [label="odim:RawSleepCSV\n(prov:Entity)", shape=box, fillcolor="#EEEEEE"];
    RawLoc   [label="odim:RawLocationCSV\n(prov:Entity)", shape=box, fillcolor="#EEEEEE"];
  }

  // Import activity
  subgraph cluster_import {
    label="Import (odim:DataTransferEvent)"; style=dashed; color=gray60; labelloc="t"; labeljust="l";
    C_IMPORT [shape=plaintext, label="", width=0, height=0, margin=0, fixedsize=true, style=invis, color=none, penwidth=0];
    Import [label="odim:A_Import\n(odim:DataTransferEvent)", shape=ellipse, fillcolor="#FFF2CC"];
  }

  // Observations (entities)
  subgraph cluster_obs {
    label=""; style=invis; color=gray60;
    ObsSteps [label="odim:Obs_Steps_D1\n(odim:ActivityMeasurement)", shape=box, fillcolor="#DDEEFF"];
    ObsSleep [label="odim:Obs_Sleep_D1\n(odim:SleepStageMeasurement)", shape=box, fillcolor="#DDEEFF"];
    ObsLoc   [label="odim:Obs_Location_D1\n(odim:DeviceLocationEstimate)", shape=box, fillcolor="#DDEEFF"];
    ObsDots  [label="… (D2..D7)", shape=plaintext];
  }

  // Daily computation + features (steps + sleep minutes)
  subgraph cluster_daily {
    label="Daily features (odim:DerivedFeature)"; style=dashed; color=gray60; labelloc="t"; labeljust="l";
    C_DAILY [shape=plaintext, label="", width=0, height=0, margin=0, fixedsize=true, style=invis, color=none, penwidth=0];
    DailyComp [label="odim:A_DailySummary\n(odim:AlgorithmicComputation)", shape=ellipse, fillcolor="#FFF2CC"];
    F1 [label="odim:F_DailySteps_D1\n(odim:DerivedFeature)", shape=box, fillcolor="#E2F0D9"];
    F2 [label="odim:F_DailySteps_D2\n(odim:DerivedFeature)", shape=box, fillcolor="#E2F0D9"];
    FDots [label="… (D3..D7)", shape=plaintext, color="#888888", fontcolor="#666666"];
    SQ1 [label="odim:F_SleepMinutes_D1\n(odim:DerivedFeature)", shape=box, fillcolor="#E2F0D9"];
    SQ2 [label="odim:F_SleepMinutes_D2\n(odim:DerivedFeature)", shape=box, fillcolor="#E2F0D9"];
  }

  // Weekly aggregation + decisions + combined phenotype
  subgraph cluster_weekly {
    label="Weekly aggregates → decisions → phenotype"; style=dashed; color=gray60; labelloc="t"; labeljust="l";
    C_WEEKLY [shape=plaintext, label="", width=0, height=0, margin=0, fixedsize=true, style=invis, color=none, penwidth=0];
    WeeklySteps [label="odim:A_WeeklyAggregateSteps\n(odim:AlgorithmicComputation)", shape=ellipse, fillcolor="#FFF2CC"];
    MeanSteps [label="odim:F_WeeklyMeanSteps\n(odim:DerivedFeature)", shape=box, fillcolor="#E2F0D9"];
    Thresh [label="odim:Threshold_LowSteps\n(prov:Entity)", shape=box, fillcolor="#FFE5D9"];
    StepsDecision [label="odim:A_StepsThresholdDecision\n(odim:AlgorithmicComputation)", shape=ellipse, fillcolor="#FFF2CC"];
    Marker [label="odim:Marker_LowActivityDuringTravel\n(odim:DerivedFeature)", shape=box, style="rounded,filled", fillcolor="#E2F0D9"];

    WeeklySleep [label="odim:A_WeeklyAggregateSleepMinutes\n(odim:AlgorithmicComputation)", shape=ellipse, fillcolor="#FFF2CC"];
    MeanSleep [label="odim:F_WeeklyMeanSleepMinutes\n(odim:DerivedFeature)", shape=box, fillcolor="#E2F0D9"];
    SleepBaseline [label="odim:Baseline_SleepMinutes\n(prov:Entity)", shape=box, fillcolor="#FFE5D9"];
    SleepDebtDecision [label="odim:A_SleepDebtDecision\n(odim:AlgorithmicComputation)", shape=ellipse, fillcolor="#FFF2CC"];
    SleepDebt [label="odim:Marker_SleepDebt_Week1\n(odim:DerivedFeature)", shape=box, fillcolor="#E2F0D9"];

    Combine [label="odim:A_MarkerDerivation\n(odim:AlgorithmicComputation)", shape=ellipse, fillcolor="#FFF2CC"];
    Phenotype [label="odim:Phenotype_TravelAssociatedInactivityWithSleepDebt\n(odim:ActivityPhenotype)", shape=box, style="rounded,filled", fillcolor="#EDE7F6"];
    Week [label="odim:Week1\n(odim:WeeklyInterval)", shape=box, fillcolor="#F3F4F6"];

    // Travel detection elements placed within weekly cluster
    TravelDetect [label="odim:A_TravelDetection\n(odim:AlgorithmicComputation)", shape=ellipse, fillcolor="#FFF2CC"];
    TravelWin [label="odim:TravelWindow_Week1\n(odim:EventWindow)", shape=box, fillcolor="#FDE2E4"];
    TravelThresh [label="odim:Threshold_TravelKm\n(prov:Entity)", shape=box, fillcolor="#FFE5D9"];
  }

  // Edges with exact predicates
  // Gentle horizontal centering: pull representative nodes toward CenterAnchor (no rank effect)
  CenterAnchor -> Lfeat       [style=invis, constraint=false, weight=8];
  CenterAnchor -> RawSleep    [style=invis, constraint=false, weight=8];
  CenterAnchor -> Import      [style=invis, constraint=false, weight=8];
  CenterAnchor -> DailyComp   [style=invis, constraint=false, weight=14];
  CenterAnchor -> F1          [style=invis, constraint=false, weight=10];
  CenterAnchor -> F2          [style=invis, constraint=false, weight=10];
  CenterAnchor -> SQ1         [style=invis, constraint=false, weight=10];
  CenterAnchor -> SQ2         [style=invis, constraint=false, weight=10];
  CenterAnchor -> FDots       [style=invis, constraint=false, weight=6];
  CenterAnchor -> Combine     [style=invis, constraint=false, weight=12];
  CenterAnchor -> Phenotype   [style=invis, constraint=false, weight=14];
  // Import used raw files (prov:used: Activity -> Entity)
  Import -> RawSteps [label="prov:used", fontsize=10];
  Import -> RawSleep [label="prov:used", fontsize=10];
  Import -> RawLoc   [label="prov:used", fontsize=10];

  // Observations were generated by Import (odim:wasGeneratedBy: Entity -> Activity)
  ObsSteps -> Import [label="odim:wasGeneratedBy", fontsize=10];
  ObsSleep -> Import [label="odim:wasGeneratedBy", fontsize=10];
  ObsLoc   -> Import [label="odim:wasGeneratedBy", fontsize=10];
  {rank=same; ObsSteps; ObsSleep; ObsLoc;}

  // Daily computation used observations (prov:used)
  DailyComp -> ObsSteps [label="prov:used", fontsize=10];
  DailyComp -> ObsSleep [label="prov:used", fontsize=10];

  // Travel detection from location observations (nodes defined in weekly cluster)
  TravelDetect -> ObsLoc [label="prov:used", fontsize=10];
  TravelDetect -> ObsDots [style=dotted, arrowhead=none];
  TravelDetect -> TravelThresh [label="prov:used", fontsize=10];
  TravelWin -> TravelDetect [label="odim:wasComputedBy", fontsize=10];

  // Daily features were computed by DailyComp (odim:wasComputedBy)
  F1 -> DailyComp [label="odim:wasComputedBy", fontsize=10];
  F2 -> DailyComp [label="odim:wasComputedBy", fontsize=10];
  SQ1 -> DailyComp [label="odim:wasComputedBy", fontsize=10];
  SQ2 -> DailyComp [label="odim:wasComputedBy", fontsize=10];
  FDots -> DailyComp [style=dotted, arrowhead=none];

  // Weekly steps aggregate and decision
  WeeklySteps -> F1 [label="prov:used", fontsize=10];
  WeeklySteps -> F2 [label="prov:used", fontsize=10];
  WeeklySteps -> FDots [style=dotted, arrowhead=none];
  MeanSteps -> WeeklySteps [label="odim:wasComputedBy", fontsize=10];
  StepsDecision -> MeanSteps [label="prov:used", fontsize=10];
  StepsDecision -> Thresh [label="prov:used", fontsize=10];
  Marker -> StepsDecision [label="odim:wasComputedBy", fontsize=10];

  // Weekly sleep minutes aggregate + sleep debt decision
  WeeklySleep -> SQ1 [label="prov:used", fontsize=10];
  WeeklySleep -> SQ2 [label="prov:used", fontsize=10];
  WeeklySleep -> FDots [style=dotted, arrowhead=none];
  MeanSleep -> WeeklySleep [label="odim:wasComputedBy", fontsize=10];
  SleepDebtDecision -> MeanSleep [label="prov:used", fontsize=10];
  SleepDebtDecision -> SleepBaseline [label="prov:used", fontsize=10];
  SleepDebt -> SleepDebtDecision [label="odim:wasComputedBy", fontsize=10];

  // Combined phenotype marker
  Combine -> Marker [label="prov:used", fontsize=10];
  Combine -> SleepDebt [label="prov:used", fontsize=10];
  Combine -> TravelWin [label="prov:used", fontsize=10];
  Phenotype -> Combine [label="odim:wasComputedBy", fontsize=10];
  Phenotype -> Week [label="odim:occursDuring", fontsize=10];

  // Align dashed clusters centrally with an invisible vertical spine
  C_RAW    -> C_IMPORT [style=invis, weight=100];
  C_IMPORT -> C_DAILY  [style=invis, weight=100];
  C_DAILY  -> C_WEEKLY [style=invis, weight=100];
  // Tie cluster centers to representative nodes (no rank effect)
  C_RAW    -> RawSleep   [style=invis, constraint=false, weight=10];
  C_IMPORT -> Import     [style=invis, constraint=false, weight=10];
  C_DAILY  -> DailyComp  [style=invis, constraint=false, weight=12];
  C_WEEKLY -> Combine    [style=invis, constraint=false, weight=12];

  // Align dashed clusters centrally with an invisible vertical spine
  C_RAW    -> C_IMPORT [style=invis, weight=100];
  C_IMPORT -> C_DAILY  [style=invis, weight=100];
  C_DAILY  -> C_WEEKLY [style=invis, weight=100];
  // Gently tie cluster centers to representative nodes (no rank effect)
  C_RAW    -> RawSleep   [style=invis, constraint=false, weight=10];
  C_IMPORT -> Import     [style=invis, constraint=false, weight=10];
  C_DAILY  -> DailyComp  [style=invis, constraint=false, weight=10];
  C_WEEKLY -> Combine    [style=invis, constraint=false, weight=10];
}
